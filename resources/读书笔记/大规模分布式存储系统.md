[TOC]

前言

## 第1章 概述

### 1.1 分布式存储概念

分布式存储系统的特性：

- 可扩展性
- 低成本
- 高性能
- 易用

分布式存储技术主要来自两个领域：**分布式系统**和**分布式数据库**。

- 数据分布
- 一致性
- 容错
- 负载均衡
- 事务与并发控制
- 易用性
- 压缩/解压缩

### 1.2 分布式存储分类

根据结构、内容的关系划分类：

- 非结构化数据：纯内容，无结构——文档、文本、图片、图像等内容。
- 结构化数据：结构和内容是分开的——schema，关系型，二维关系。
- 半结构化数据：结构和内容混在一起——HTML文档等。

将分布式存储系统分为四类：

1. 分布式文件系统：非结构化数据——图片、照片、视频，二进制大对象（Binary Large Object，Blob）。常常作为分布式表格、分布式数据库的底层存储。使用数据库（chunk）来组织数据。
    1. Blob对象
    2. 定长块
    3. 大文件 
2. 分布式键值系统：关系简单的半结构化数据，只提供基于**主键**的CRUD。是分布式表格的一种简化实现，一般用作**缓存**
3. 分布式表格系统：
4. 分布式数据库 

分类|结构内容关系|使用技术|应用场景
---|---|---|---
分布式文件系统|非结构化数据|数据块（Blob、定长块、大文件）|
分布式键值系统|简单的半结构化|只基于主键的CRUD，一致性哈希|淘宝Tair，Memchache，Amazon DynamoDB
分布式表格系统|复杂的半结构化|表格，CRUD，主键范围|Google Bigtable
分布式数据库|结构化数据|二维表格|MySQL Sharding，Amazon RDS，Azure，NoSQL

# 第一篇 基础篇

## 第2章 单机存储系统

### 2.1 硬件基础

1. CPU架构

多处理结构（Symmetric Multi-Processing, SMP）：共享

2. IO总线
3. 网络拓扑
4. 性能参数
5. 存储层次架构

### 2.2 单机存储引擎

1. 哈希存储引擎
2. B树存储引擎
3. LSM树存储引擎

### 2.3 数据模型
1. 文件模型
2. 关系模型
3. 键值模型
4. SQL与NoSQL

### 2.4 事务与并发控制

1. 事务
2. 并发控制

### 2.5 故障恢复

1. 操作日志
2. 重做日志
3. 优化手段

### 2.6 数据压缩

1. 压缩算法
2. 列式存储

## 第3章 分布式系统

分布式面临的第一个问题是：**数据分布**带来的**一致性**问题。

分布式有两个重要的协议：

1. Paxos选择协议：多个节点之间达成一致，用于实现**总控节点**选举。
2. 两阶段提交协议：保证跨多个节点操作的原子性。

### 3.1 基本概念

异常：分布式存储系统的一个核心问题是——**自动容错**。服务器节点不可靠，网络不可靠。

1. 异常类型：
    - 服务器宕机
    - 网络异常：消息丢失、消息乱序、网络包数据错误。
    - 磁盘故障：①磁盘损坏；②磁盘数据错误。
2. 超时：发起RPC（Remote Procedure Call），三种状态：成功、失败、超时。

一致性：**副本**是分布式存储系统容错技术的**唯一手段**。

两个角度理解一致性：

- 客户端：用户
    - 强一致性：
    - 弱一致性：
    - 最终一致性
        - 读写一致性：客户端自己的读写一直，不保证其他用户。
        - 会话一致性：会话期间读写一致，不同会话不保证。
        - 单调读一致性：读的后续操作不读更早的值。
        - 单调写 一致性 ：
- 存储系统
    - 副本一致性：存储系统的多个副本之间。
    - 更新顺序一致性：是否按照相同的顺序执行更新操作。

衡量指标

1. 性能：
    - 系统吞吐量——每秒处理的读操作（QPS,Query Per Second）或者写操作（TPS,Transaction Per Second）。
    - 系统响应延迟
2. 可用性（availability）
3. 一致性
4. 可扩展性（scalability）

### 3.2 性能分析

### 3.3 数据分布

哈希分布：散列特性很好，数据均匀地分配到集群中。但是散列特性很好的哈希函数很难。

- 数据倾斜：（大用户问题）大用户始终由一台服务器处理。处理方式有：
    - 手动拆分：
    - 自动拆分：
- 数据迁移：服务器上线下线，N值发生变化，映射关系需要重新调整，数据重新分布。处理方式有：
    - 云数据服务器：
    - 一致性哈希算法（DHT，Distributed Hash Table）：

> 哈希分布破坏了数据的有序性，只支持随机读取操作。

顺序分布：将大表顺序划分为连续的范围，每个范围成为一个子表，**总控服务器**负责将子表按照一定的策略分配到存储节点上。但是子表的分裂的合并，也极大增加系统复杂性。

负载均衡：

- 总控结点：根据全局负载信息进行整体调度。
- 工作结点：通过心跳包（Heartbeat，定时发送）将节点负载相关信息发送给总控节点。

>负载均衡需要**执行数据迁移操作**。

### 3.4 复制

①主副本（Primary）②备副本（Backup）

>复制协议：二者的区别在于*用户的写请求是否需要同步到备副本才可以返回成功？*。

1. 强同步复制：
2. 异步复制：

>**一致性和可用性是矛盾的**

1. 强同步复制可以保证主备副本之间的一致性，但是备副本故障，阻塞存储系统的写服务，系统可用性受到影响；
2. 异步复制的可用性相对较好，但是一致性得不到保障，主备副本之间故障会出校数据丢失的情况。

复制的概述

1. 基于主副本的复制协议（Primary-dasedprotocol）
2. 基于写多个存储节点的复制协议（Replicated-write protocol）

一致性与可用性

>CAP理论：一致性、可用性、分区可容忍性三者不能同时满足。

自动容错解决了分区可容忍性。因此，一致性和可用性不能同时满足，需要权衡。

1. 最大保护模式：即强同步复制模式
2. 最大性能模式：即异步复制模式
3. 最大可用性模式：折中。

### 3.5 容错

常见故障：

故障检测：心跳，租约（lease）

故障恢复：

1. 单层结构：对每个数据分片维护多个副本
2. 双层结构：
    - 存储层：对每个数据分片维护多个副本
    - 服务层：只有一个副本提供服务 

>为了实现总控节点的高可用性：总控节点的状态实时同步到备机；故障时，外部服务**选举**备机作为新的总控节点。（维护一套通过Paxos协议实现的分布式锁服务）

### 3.6 可扩展性

总控节点

1. 执行全局调度
2. 维护文件系统目录树

内存可能成为瓶颈。

采用两级结构：在总控节点和工作节点之间增加一层**元数据节点**，每个元数据节点只维护一部分，而不是整个分布式文件系统的元数据。 

数据库扩容

异构系统

### 3.7 分布式协议

两阶段提交协议：同来实现分布式事务，保证多个节点操作的原子性。

1. 协调者
2. 参与者

Paxos协议：解决多个节点之间的一致性问题。

Paxos与2PC：副本一致性+操作原子性。

- 2PC保证多个数据分片上的操作原子性
- Paxos解决2PC协议中协调者宕机问题

### 3.8 跨机房部署

# 第二篇 范型篇

## 第4章 分布式文件系统

### 4.1 Google文件系统

1. 系统架构
2. 关键问题
3. Master设计
4. ChunkServer设计
5. 讨论

### 4.2 Taobao File System

1. 系统架构
2. 讨论

### 4.3 Facebook Haystack

1. 系统架构
2. 讨论

### 4.4 内容分发网络

1. CDN架构
2. 讨论

## 第5章 分布式键值系统

### 5.1 Amazon Dynamo

1. 数据分布
2. 一致性与复制
3. 容错
4. 负载均衡
5. 读写流程
6. 单机实现
7. 讨论

### 5.2 淘宝Tair

1. 系统架构
2. 关键问题
3. 讨论

## 第6章 分布式表格系统

### 6.1 Google Bigtable

1. 架构
2. 数据分布
3. 复制与一致性
4. 容错
5. 负载均衡
6. 分裂与合并
7. 单机存储
8. 垃圾回收
9. 讨论

### 6.2 Google Megastore

1. 系统架构
2. 实体组
3. 并发控制
4. 复制
5. 索引
6. 协调者
7. 读取流程
8. 写入流程
9. 讨论

### 6.3 Windows Azure Storage

1. 整体架构
2. 文件流层
3. 分区层
4. 讨论

## 第7章 分布式数据库

### 7.1 数据库中间层

1. 架构
2. 扩容
3. 讨论

### 7.2 Microsoft SQL Azure

1. 数据模型
2. 架构
3. 复制与一致性
4. 容错
5. 负载均衡
6. 多租户
7. 讨论

### 7.3 Google Spanner

1. 数据模型
2. 架构
3. 复制与一致性
4. TrueTime
5. 并发控制
6. 数据迁移
7. 讨论

# 第三篇 实践篇

## 第8章 OceanBase架构初探

### 8.1 背景简介

### 8.2 设计思路

### 8.3 系统架构

1. 整体架构图
2. 客户端
3. RootServer
4. MergeServer
5. ChunkServer
6. UpdateServer
7. 定期合并&数据分发

### 8.4 架构剖析

1. 一致性选择
2. 数据结构
3. 可靠性与可用性
4. 读写事务
5. 单点性能
6. SSD支持
7. 数据正确性
8. 分层结构

## 第9章 分布式存储引擎

### 9.1 公共模块

1. 内存管理
2. 基础数据结构
3. 锁
4. 任务队列
5. 网络框架
6. 压缩与解压缩

### 9.2 RootServer实现机制

1. 数据结构
2. 子表复制与负载均衡
3. 子表分裂与合并
4. UpdateServer选主
5. RootServer主备

### 9.3 UpdateServer实现机制

1. 存储引擎
2. 任务模型
3. 主备同步

### 9.4 ChunkServer实现机制

1. 子表管理
2. SSTable
3. 缓存实现
4. IO实现
5. 定期合并&数据分发
6. 定期合并限速

### 9.5 消除更新瓶颈

1. 读写优化回顾
2. 数据旁路导入
3. 数据分区

## 第10章 数据库功能

### 10.1 整体结构

### 10.2 只读事务

1. 物理操作符接口
2. 单表操作
3. 多表操作
4. SQL执行本地化

### 10.3 写事务

1. 写事务执行流程
2. 多版本并发控制

### 10.4 OLAP业务支持

1. 并发查询
2. 列式存储

### 10.5 特色功能

1. 大表左连接
2. 数据过期与批量删除

## 第11章 质量保证、运维及实践

### 11.1 质量保证

1. RD开发
2. QA测试
3. 试运行

### 11.2 使用与运维

1. 使用
2. 运维

### 11.3 应用

1. 收藏夹
2. 天猫评价
3. 直通车报表

### 11.4 最佳实践

1. 系统发展路径
2. 人员成长
3. 系统设计
4. 系统实现
5. 使用与运维
6. 工程现象
7 经验法则

# 第四篇 专题篇

## 第12章 云存储

### 12.1 云存储的概念

### 12.2 云存储的产品形态

### 12.3 云存储技术

### 12.4 云存储的核心优势

### 12.5 云平台整体架构

1. Amazon云平台
2. Google云平台
3. Microsoft云平台
4. 云平台架构

### 12.6 云存储技术体系

### 12.7 云存储安全

## 第13章 大数据

### 13.1 大数据的概念

### 13.2 MapReduce

### 13.3 MapReduce扩展

1. Google Tenzing
2. Microsoft Dryad
3. Google Pregel

### 13.4 流式计算

1. 原理
2. Yahoo S4
3. Twitter Storm

### 13.5 实时分析

1. MPP架构
2. EMC Greenplum
3. HP Vertica
4. Google Dremel

参考资料